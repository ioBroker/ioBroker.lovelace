{"version":3,"file":"4b724330.js","mappings":";;AAyFA;AAMA;;AAEA;;AAjBA;AACA;AACA;;;;AAkDA;;AAOA;;AAEA;;AAGA;;AAEA;;AAKA;AACA;AACA;AAIA;AACA;;;;;AAMA;;AAGA;AACA;AACA;;AAGA;AACA;;;AAsBA;AACA;;AAEA;AAzBA;;;;AA8BA;;;;AAOA;AACA;;;AAGA;;;AAKA;AAKA;AACA;;AAIA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA1MA","sources":["webpack://home-assistant-frontend/./src/panels/logbook/ha-logbook.ts"],"sourcesContent":["import { Layout1d, scroll } from \"@lit-labs/virtualizer\";\nimport {\n  css,\n  CSSResultGroup,\n  html,\n  LitElement,\n  PropertyValues,\n  TemplateResult,\n} from \"lit\";\nimport { customElement, eventOptions, property } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport { DOMAINS_WITH_DYNAMIC_PICTURE } from \"../../common/const\";\nimport { formatDate } from \"../../common/datetime/format_date\";\nimport { formatTimeWithSeconds } from \"../../common/datetime/format_time\";\nimport { restoreScroll } from \"../../common/decorators/restore-scroll\";\nimport { fireEvent } from \"../../common/dom/fire_event\";\nimport { computeDomain } from \"../../common/entity/compute_domain\";\nimport { computeRTL, emitRTLDirection } from \"../../common/util/compute_rtl\";\nimport \"../../components/entity/state-badge\";\nimport \"../../components/ha-circular-progress\";\nimport \"../../components/ha-relative-time\";\nimport { LogbookEntry } from \"../../data/logbook\";\nimport { TraceContexts } from \"../../data/trace\";\nimport { haStyle, haStyleScrollbar } from \"../../resources/styles\";\nimport { HomeAssistant } from \"../../types\";\n\n@customElement(\"ha-logbook\")\nclass HaLogbook extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property({ attribute: false }) public userIdToName = {};\n\n  @property({ attribute: false })\n  public traceContexts: TraceContexts = {};\n\n  @property({ attribute: false }) public entries: LogbookEntry[] = [];\n\n  @property({ type: Boolean, attribute: \"narrow\" })\n  public narrow = false;\n\n  @property({ attribute: \"rtl\", type: Boolean })\n  private _rtl = false;\n\n  @property({ type: Boolean, attribute: \"virtualize\", reflect: true })\n  public virtualize = false;\n\n  @property({ type: Boolean, attribute: \"no-icon\" })\n  public noIcon = false;\n\n  @property({ type: Boolean, attribute: \"no-name\" })\n  public noName = false;\n\n  @property({ type: Boolean, attribute: \"relative-time\" })\n  public relativeTime = false;\n\n  // @ts-ignore\n  @restoreScroll(\".container\") private _savedScrollPos?: number;\n\n  protected shouldUpdate(changedProps: PropertyValues<this>) {\n    const oldHass = changedProps.get(\"hass\") as HomeAssistant | undefined;\n    const languageChanged =\n      oldHass === undefined || oldHass.locale !== this.hass.locale;\n\n    return (\n      changedProps.has(\"entries\") ||\n      changedProps.has(\"traceContexts\") ||\n      languageChanged\n    );\n  }\n\n  protected updated(_changedProps: PropertyValues) {\n    const oldHass = _changedProps.get(\"hass\") as HomeAssistant | undefined;\n\n    if (oldHass === undefined || oldHass.language !== this.hass.language) {\n      this._rtl = computeRTL(this.hass);\n    }\n  }\n\n  protected render(): TemplateResult {\n    if (!this.entries?.length) {\n      return html`\n        <div class=\"container no-entries\" .dir=${emitRTLDirection(this._rtl)}>\n          ${this.hass.localize(\"ui.components.logbook.entries_not_found\")}\n        </div>\n      `;\n    }\n\n    return html`\n      <div\n        class=\"container ha-scrollbar ${classMap({\n          narrow: this.narrow,\n          rtl: this._rtl,\n          \"no-name\": this.noName,\n          \"no-icon\": this.noIcon,\n        })}\"\n        @scroll=${this._saveScrollPos}\n      >\n        ${this.virtualize\n          ? scroll({\n              items: this.entries,\n              layout: Layout1d,\n              renderItem: (item: LogbookEntry, index) =>\n                this._renderLogbookItem(item, index),\n            })\n          : this.entries.map((item, index) =>\n              this._renderLogbookItem(item, index)\n            )}\n      </div>\n    `;\n  }\n\n  private _renderLogbookItem(\n    item: LogbookEntry,\n    index?: number\n  ): TemplateResult {\n    if (index === undefined) {\n      return html``;\n    }\n\n    const previous = this.entries[index - 1];\n    const stateObj = item.entity_id\n      ? this.hass.states[item.entity_id]\n      : undefined;\n    const item_username =\n      item.context_user_id && this.userIdToName[item.context_user_id];\n    const domain = item.entity_id\n      ? computeDomain(item.entity_id)\n      : // Domain is there if there is no entity ID.\n        item.domain!;\n\n    return html`\n      <div class=\"entry-container\">\n        ${index === 0 ||\n        (item?.when &&\n          previous?.when &&\n          new Date(item.when).toDateString() !==\n            new Date(previous.when).toDateString())\n          ? html`\n              <h4 class=\"date\">\n                ${formatDate(new Date(item.when), this.hass.locale)}\n              </h4>\n            `\n          : html``}\n\n        <div class=\"entry ${classMap({ \"no-entity\": !item.entity_id })}\">\n          <div class=\"icon-message\">\n            ${!this.noIcon\n              ? // We do not want to use dynamic entity pictures (e.g., from media player) for the log book rendering,\n                // as they would present a false state in the log (played media right now vs actual historic data).\n                html`\n                  <state-badge\n                    .hass=${this.hass}\n                    .overrideIcon=${item.icon}\n                    .overrideImage=${DOMAINS_WITH_DYNAMIC_PICTURE.has(domain)\n                      ? \"\"\n                      : stateObj?.attributes.entity_picture_local ||\n                        stateObj?.attributes.entity_picture}\n                    .stateObj=${stateObj}\n                    .stateColor=${false}\n                  ></state-badge>\n                `\n              : \"\"}\n            <div class=\"message-relative_time\">\n              <div class=\"message\">\n                ${!this.noName\n                  ? html`<a\n                      href=\"#\"\n                      @click=${this._entityClicked}\n                      .entityId=${item.entity_id}\n                      ><span class=\"name\">${item.name}</span></a\n                    >`\n                  : \"\"}\n                ${item.message}\n                ${item_username\n                  ? ` ${this.hass.localize(\n                      \"ui.components.logbook.by\"\n                    )} ${item_username}`\n                  : !item.context_event_type\n                  ? \"\"\n                  : item.context_event_type === \"call_service\"\n                  ? // Service Call\n                    ` ${this.hass.localize(\"ui.components.logbook.by_service\")}\n                  ${item.context_domain}.${item.context_service}`\n                  : item.context_entity_id === item.entity_id\n                  ? // HomeKit or something that self references\n                    ` ${this.hass.localize(\"ui.components.logbook.by\")}\n                  ${\n                    item.context_name\n                      ? item.context_name\n                      : item.context_event_type\n                  }`\n                  : // Another entity such as an automation or script\n                    html` ${this.hass.localize(\"ui.components.logbook.by\")}\n                      <a\n                        href=\"#\"\n                        @click=${this._entityClicked}\n                        .entityId=${item.context_entity_id}\n                        class=\"name\"\n                        >${item.context_entity_id_name}</a\n                      >`}\n              </div>\n              <div class=\"secondary\">\n                <span\n                  >${formatTimeWithSeconds(\n                    new Date(item.when),\n                    this.hass.locale\n                  )}</span\n                >\n                -\n                <ha-relative-time\n                  .hass=${this.hass}\n                  .datetime=${item.when}\n                  capitalize\n                ></ha-relative-time>\n                ${item.domain === \"automation\" &&\n                item.context_id! in this.traceContexts\n                  ? html`\n                      -\n                      <a\n                        href=${`/config/automation/trace/${\n                          this.traceContexts[item.context_id!].item_id\n                        }?run_id=${\n                          this.traceContexts[item.context_id!].run_id\n                        }`}\n                        @click=${this._close}\n                        >${this.hass.localize(\n                          \"ui.components.logbook.show_trace\"\n                        )}</a\n                      >\n                    `\n                  : \"\"}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  @eventOptions({ passive: true })\n  private _saveScrollPos(e: Event) {\n    this._savedScrollPos = (e.target as HTMLDivElement).scrollTop;\n  }\n\n  private _entityClicked(ev: Event) {\n    const entityId = (ev.currentTarget as any).entityId;\n    if (!entityId) {\n      return;\n    }\n\n    ev.preventDefault();\n    ev.stopPropagation();\n    fireEvent(this, \"hass-more-info\", {\n      entityId: entityId,\n    });\n  }\n\n  private _close(): void {\n    setTimeout(() => fireEvent(this, \"closed\"), 500);\n  }\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyle,\n      haStyleScrollbar,\n      css`\n        :host([virtualize]) {\n          display: block;\n          height: 100%;\n        }\n\n        .rtl {\n          direction: ltr;\n        }\n\n        .entry-container {\n          width: 100%;\n        }\n\n        .entry {\n          display: flex;\n          width: 100%;\n          line-height: 2em;\n          padding: 8px 16px;\n          box-sizing: border-box;\n          border-top: 1px solid var(--divider-color);\n        }\n\n        .entry.no-entity,\n        .no-name .entry {\n          cursor: default;\n        }\n\n        .entry:hover {\n          background-color: rgba(var(--rgb-primary-text-color), 0.04);\n        }\n\n        .narrow:not(.no-icon) .time {\n          margin-left: 32px;\n        }\n\n        .message-relative_time {\n          display: flex;\n          flex-direction: column;\n        }\n\n        .secondary {\n          font-size: 12px;\n          line-height: 1.7;\n        }\n\n        .secondary a {\n          color: var(--secondary-text-color);\n        }\n\n        .date {\n          margin: 8px 0;\n          padding: 0 16px;\n        }\n\n        .narrow .date {\n          padding: 0 8px;\n        }\n\n        .rtl .date {\n          direction: rtl;\n        }\n\n        .icon-message {\n          display: flex;\n          align-items: center;\n        }\n\n        .no-entries {\n          text-align: center;\n          color: var(--secondary-text-color);\n        }\n\n        state-badge {\n          margin-right: 16px;\n          flex-shrink: 0;\n          color: var(--state-icon-color);\n        }\n\n        .message {\n          color: var(--primary-text-color);\n        }\n\n        .no-name .message:first-letter {\n          text-transform: capitalize;\n        }\n\n        a {\n          color: var(--primary-color);\n        }\n\n        .container {\n          max-height: var(--logbook-max-height);\n        }\n\n        :host([virtualize]) .container {\n          height: 100%;\n        }\n\n        .narrow .entry {\n          line-height: 1.5;\n          padding: 8px;\n        }\n\n        .narrow .icon-message state-badge {\n          margin-left: 0;\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-logbook\": HaLogbook;\n  }\n}\n"],"names":[],"sourceRoot":""}