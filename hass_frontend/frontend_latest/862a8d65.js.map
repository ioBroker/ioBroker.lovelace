{"version":3,"file":"862a8d65.js","mappings":";;AAYA;;AAEA;;;;AAIA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA;AC6DA;;AAEA;;AAGA;AACA;;;AAGA;;;;AAIA;;;;AAIA;;;;AAIA;AAEA;AAEA;AACA;;;AAIA;;;AAIA;AAGA;AACA;;AAEA;;;;AAKA;AACA;;;AAOA;;AAGA;;;;;AAMA;;;AAIA;;;;AAIA;;AAGA;;AAGA;;;;AAIA;;AAEA;;;AArFA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAxCA","sources":["webpack://home-assistant-frontend/./src/components/ha-dialog.ts","webpack://home-assistant-frontend/./src/dialogs/voice-command-dialog/ha-voice-command-dialog.ts"],"sourcesContent":["import { Dialog } from \"@material/mwc-dialog\";\nimport { mdiClose } from \"@mdi/js\";\nimport { css, CSSResultGroup, html, TemplateResult } from \"lit\";\nimport { customElement } from \"lit/decorators\";\nimport { computeRTLDirection } from \"../common/util/compute_rtl\";\nimport type { HomeAssistant } from \"../types\";\nimport \"./ha-icon-button\";\n\nexport const createCloseHeading = (\n  hass: HomeAssistant,\n  title: string | TemplateResult\n) => html`\n  <span class=\"header_title\">${title}</span>\n  <ha-icon-button\n    .label=${hass.localize(\"ui.dialogs.generic.close\")}\n    .path=${mdiClose}\n    dialogAction=\"close\"\n    class=\"header_button\"\n    dir=${computeRTLDirection(hass)}\n  ></ha-icon-button>\n`;\n\n@customElement(\"ha-dialog\")\n// @ts-expect-error\nexport class HaDialog extends Dialog {\n  public scrollToPos(x: number, y: number) {\n    this.contentElement?.scrollTo(x, y);\n  }\n\n  protected renderHeading() {\n    return html`<slot name=\"heading\"> ${super.renderHeading()} </slot>`;\n  }\n\n  protected static get styles(): CSSResultGroup {\n    return [\n      Dialog.styles,\n      css`\n        .mdc-dialog {\n          --mdc-dialog-scroll-divider-color: var(--divider-color);\n          z-index: var(--dialog-z-index, 7);\n          -webkit-backdrop-filter: var(--dialog-backdrop-filter, none);\n          backdrop-filter: var(--dialog-backdrop-filter, none);\n        }\n        .mdc-dialog__actions {\n          justify-content: var(--justify-action-buttons, flex-end);\n          padding-bottom: max(env(safe-area-inset-bottom), 8px);\n        }\n        .mdc-dialog__actions span:nth-child(1) {\n          flex: var(--secondary-action-button-flex, unset);\n        }\n        .mdc-dialog__actions span:nth-child(2) {\n          flex: var(--primary-action-button-flex, unset);\n        }\n        .mdc-dialog__container {\n          align-items: var(--vertial-align-dialog, center);\n        }\n        .mdc-dialog__title::before {\n          display: block;\n          height: 20px;\n        }\n        .mdc-dialog .mdc-dialog__content {\n          position: var(--dialog-content-position, relative);\n          padding: var(--dialog-content-padding, 20px 24px);\n        }\n        :host([hideactions]) .mdc-dialog .mdc-dialog__content {\n          padding-bottom: max(\n            var(--dialog-content-padding, 20px),\n            env(safe-area-inset-bottom)\n          );\n        }\n        .mdc-dialog .mdc-dialog__surface {\n          position: var(--dialog-surface-position, relative);\n          top: var(--dialog-surface-top);\n          min-height: var(--mdc-dialog-min-height, auto);\n          border-radius: var(\n            --ha-dialog-border-radius,\n            var(--ha-card-border-radius, 4px)\n          );\n        }\n        :host([flexContent]) .mdc-dialog .mdc-dialog__content {\n          display: flex;\n          flex-direction: column;\n        }\n        .header_button {\n          position: absolute;\n          right: 16px;\n          top: 10px;\n          text-decoration: none;\n          color: inherit;\n        }\n        .header_title {\n          margin-right: 40px;\n        }\n        [dir=\"rtl\"].header_button {\n          right: auto;\n          left: 16px;\n        }\n        [dir=\"rtl\"].header_title {\n          margin-left: 40px;\n          margin-right: 0px;\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-dialog\": HaDialog;\n  }\n}\n","/* eslint-disable lit/prefer-static-styles */\nimport { mdiMicrophone } from \"@mdi/js\";\nimport \"@polymer/paper-input/paper-input\";\nimport type { PaperInputElement } from \"@polymer/paper-input/paper-input\";\nimport {\n  css,\n  CSSResultGroup,\n  html,\n  LitElement,\n  PropertyValues,\n  TemplateResult,\n} from \"lit\";\nimport { customElement, property, state, query } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport { fireEvent } from \"../../common/dom/fire_event\";\nimport { SpeechRecognition } from \"../../common/dom/speech-recognition\";\nimport { uid } from \"../../common/util/uid\";\nimport \"../../components/ha-icon-button\";\nimport {\n  AgentInfo,\n  getAgentInfo,\n  processText,\n  setConversationOnboarding,\n} from \"../../data/conversation\";\nimport { haStyleDialog } from \"../../resources/styles\";\nimport type { HomeAssistant } from \"../../types\";\nimport \"../../components/ha-dialog\";\nimport type { HaDialog } from \"../../components/ha-dialog\";\nimport \"@material/mwc-button/mwc-button\";\n\ninterface Message {\n  who: string;\n  text?: string;\n  error?: boolean;\n}\n\ninterface Results {\n  transcript: string;\n  final: boolean;\n}\n\n@customElement(\"ha-voice-command-dialog\")\nexport class HaVoiceCommandDialog extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property() public results: Results | null = null;\n\n  @state() private _conversation: Message[] = [\n    {\n      who: \"hass\",\n      text: \"\",\n    },\n  ];\n\n  @state() private _opened = false;\n\n  @state() private _agentInfo?: AgentInfo;\n\n  @query(\"ha-dialog\", true) private _dialog!: HaDialog;\n\n  private recognition!: SpeechRecognition;\n\n  private _conversationId?: string;\n\n  public async showDialog(): Promise<void> {\n    this._opened = true;\n    if (SpeechRecognition) {\n      this._startListening();\n    }\n    this._agentInfo = await getAgentInfo(this.hass);\n  }\n\n  public async closeDialog(): Promise<void> {\n    this._opened = false;\n    if (this.recognition) {\n      this.recognition.abort();\n    }\n    fireEvent(this, \"dialog-closed\", { dialog: this.localName });\n  }\n\n  protected render(): TemplateResult {\n    if (!this._opened) {\n      return html``;\n    }\n    return html`\n      <ha-dialog open @closed=${this.closeDialog}>\n        <div>\n          ${this._agentInfo && this._agentInfo.onboarding\n            ? html`\n                <div class=\"onboarding\">\n                  ${this._agentInfo.onboarding.text}\n                  <div class=\"side-by-side\" @click=${this._completeOnboarding}>\n                    <a\n                      class=\"button\"\n                      href=${this._agentInfo.onboarding.url}\n                      target=\"_blank\"\n                      rel=\"noreferrer\"\n                      ><mwc-button unelevated\n                        >${this.hass.localize(\"ui.common.yes\")}!</mwc-button\n                      ></a\n                    >\n                    <mwc-button outlined\n                      >${this.hass.localize(\"ui.common.no\")}</mwc-button\n                    >\n                  </div>\n                </div>\n              `\n            : \"\"}\n          ${this._conversation.map(\n            (message) => html`\n              <div class=${this._computeMessageClasses(message)}>\n                ${message.text}\n              </div>\n            `\n          )}\n          ${this.results\n            ? html`\n                <div class=\"message user\">\n                  <span\n                    class=${classMap({\n                      interimTranscript: !this.results.final,\n                    })}\n                    >${this.results.transcript}</span\n                  >${!this.results.final ? \"…\" : \"\"}\n                </div>\n              `\n            : \"\"}\n        </div>\n        <div class=\"input\" slot=\"primaryAction\">\n          <paper-input\n            @keyup=${this._handleKeyUp}\n            .label=${this.hass.localize(\n              `ui.dialogs.voice_command.${\n                SpeechRecognition ? \"label_voice\" : \"label\"\n              }`\n            )}\n            autofocus\n          >\n            ${SpeechRecognition\n              ? html`\n                  <span suffix=\"\" slot=\"suffix\">\n                    ${this.results\n                      ? html`\n                          <div class=\"bouncer\">\n                            <div class=\"double-bounce1\"></div>\n                            <div class=\"double-bounce2\"></div>\n                          </div>\n                        `\n                      : \"\"}\n                    <ha-icon-button\n                      .path=${mdiMicrophone}\n                      @click=${this._toggleListening}\n                    >\n                    </ha-icon-button>\n                  </span>\n                `\n              : \"\"}\n          </paper-input>\n          ${this._agentInfo && this._agentInfo.attribution\n            ? html`\n                <a\n                  href=${this._agentInfo.attribution.url}\n                  class=\"attribution\"\n                  target=\"_blank\"\n                  rel=\"noreferrer\"\n                  >${this._agentInfo.attribution.name}</a\n                >\n              `\n            : \"\"}\n        </div>\n      </ha-dialog>\n    `;\n  }\n\n  protected firstUpdated(changedProps: PropertyValues) {\n    super.updated(changedProps);\n    this._conversationId = uid();\n    this._conversation = [\n      {\n        who: \"hass\",\n        text: this.hass.localize(\"ui.dialogs.voice_command.how_can_i_help\"),\n      },\n    ];\n  }\n\n  protected updated(changedProps: PropertyValues) {\n    super.updated(changedProps);\n    if (changedProps.has(\"_conversation\") || changedProps.has(\"results\")) {\n      this._scrollMessagesBottom();\n    }\n  }\n\n  private _addMessage(message: Message) {\n    this._conversation = [...this._conversation, message];\n  }\n\n  private _handleKeyUp(ev: KeyboardEvent) {\n    const input = ev.target as PaperInputElement;\n    if (ev.keyCode === 13 && input.value) {\n      this._processText(input.value);\n      input.value = \"\";\n    }\n  }\n\n  private _completeOnboarding() {\n    setConversationOnboarding(this.hass, true);\n    this._agentInfo! = { ...this._agentInfo, onboarding: undefined };\n  }\n\n  private _initRecognition() {\n    this.recognition = new SpeechRecognition();\n    this.recognition.interimResults = true;\n    this.recognition.lang = \"en-US\";\n\n    this.recognition.onstart = () => {\n      this.results = {\n        final: false,\n        transcript: \"\",\n      };\n    };\n    this.recognition.onerror = (event) => {\n      this.recognition!.abort();\n      // @ts-ignore\n      if (event.error !== \"aborted\") {\n        const text =\n          this.results && this.results.transcript\n            ? this.results.transcript\n            : `<${this.hass.localize(\n                \"ui.dialogs.voice_command.did_not_hear\"\n              )}>`;\n        this._addMessage({ who: \"user\", text, error: true });\n      }\n      this.results = null;\n    };\n    this.recognition.onend = () => {\n      // Already handled by onerror\n      if (this.results == null) {\n        return;\n      }\n      const text = this.results.transcript;\n      this.results = null;\n      if (text) {\n        this._processText(text);\n      } else {\n        this._addMessage({\n          who: \"user\",\n          text: `<${this.hass.localize(\n            \"ui.dialogs.voice_command.did_not_hear\"\n          )}>`,\n          error: true,\n        });\n      }\n    };\n\n    this.recognition.onresult = (event) => {\n      const result = event.results[0];\n      this.results = {\n        transcript: result[0].transcript,\n        final: result.isFinal,\n      };\n    };\n  }\n\n  private async _processText(text: string) {\n    if (this.recognition) {\n      this.recognition.abort();\n    }\n    this._addMessage({ who: \"user\", text });\n    const message: Message = {\n      who: \"hass\",\n      text: \"…\",\n    };\n    // To make sure the answer is placed at the right user text, we add it before we process it\n    this._addMessage(message);\n    try {\n      const response = await processText(\n        this.hass,\n        text,\n        this._conversationId!\n      );\n      const plain = response.speech.plain;\n      message.text = plain.speech;\n\n      this.requestUpdate(\"_conversation\");\n    } catch {\n      message.text = this.hass.localize(\"ui.dialogs.voice_command.error\");\n      message.error = true;\n      this.requestUpdate(\"_conversation\");\n    }\n  }\n\n  private _toggleListening() {\n    if (!this.results) {\n      this._startListening();\n    } else {\n      this.recognition!.stop();\n    }\n  }\n\n  private _startListening() {\n    if (!this.recognition) {\n      this._initRecognition();\n    }\n\n    if (this.results) {\n      return;\n    }\n\n    this.results = {\n      transcript: \"\",\n      final: false,\n    };\n    this.recognition!.start();\n  }\n\n  private _scrollMessagesBottom() {\n    this._dialog.scrollToPos(0, 99999);\n  }\n\n  private _computeMessageClasses(message: Message) {\n    return `message ${message.who} ${message.error ? \" error\" : \"\"}`;\n  }\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyleDialog,\n      css`\n        ha-icon-button {\n          color: var(--secondary-text-color);\n        }\n\n        ha-icon-button[active] {\n          color: var(--primary-color);\n        }\n\n        ha-dialog {\n          --primary-action-button-flex: 1;\n          --secondary-action-button-flex: 0;\n          --mdc-dialog-max-width: 450px;\n        }\n\n        a.button {\n          text-decoration: none;\n        }\n        a.button > mwc-button {\n          width: 100%;\n        }\n        .onboarding {\n          border-bottom: 1px solid var(--divider-color);\n        }\n        .side-by-side {\n          display: flex;\n          margin: 8px 0;\n        }\n        .side-by-side > * {\n          flex: 1 0;\n          padding: 4px;\n        }\n        .attribution {\n          color: var(--secondary-text-color);\n        }\n        .message {\n          font-size: 18px;\n          clear: both;\n          margin: 8px 0;\n          padding: 8px;\n          border-radius: 15px;\n        }\n\n        .message.user {\n          margin-left: 24px;\n          float: right;\n          text-align: right;\n          border-bottom-right-radius: 0px;\n          background-color: var(--light-primary-color);\n          color: var(--text-light-primary-color, var(--primary-text-color));\n        }\n\n        .message.hass {\n          margin-right: 24px;\n          float: left;\n          border-bottom-left-radius: 0px;\n          background-color: var(--primary-color);\n          color: var(--text-primary-color);\n        }\n\n        .message a {\n          color: var(--text-primary-color);\n        }\n\n        .message img {\n          width: 100%;\n          border-radius: 10px;\n        }\n\n        .message.error {\n          background-color: var(--error-color);\n          color: var(--text-primary-color);\n        }\n\n        .interimTranscript {\n          color: var(--secondary-text-color);\n        }\n\n        .bouncer {\n          width: 48px;\n          height: 48px;\n          position: absolute;\n          top: 0;\n        }\n        .double-bounce1,\n        .double-bounce2 {\n          width: 48px;\n          height: 48px;\n          border-radius: 50%;\n          background-color: var(--primary-color);\n          opacity: 0.2;\n          position: absolute;\n          top: 0;\n          left: 0;\n          -webkit-animation: sk-bounce 2s infinite ease-in-out;\n          animation: sk-bounce 2s infinite ease-in-out;\n        }\n        .double-bounce2 {\n          -webkit-animation-delay: -1s;\n          animation-delay: -1s;\n        }\n        @-webkit-keyframes sk-bounce {\n          0%,\n          100% {\n            -webkit-transform: scale(0);\n          }\n          50% {\n            -webkit-transform: scale(1);\n          }\n        }\n        @keyframes sk-bounce {\n          0%,\n          100% {\n            transform: scale(0);\n            -webkit-transform: scale(0);\n          }\n          50% {\n            transform: scale(1);\n            -webkit-transform: scale(1);\n          }\n        }\n\n        @media all and (max-width: 450px), all and (max-height: 500px) {\n          .message {\n            font-size: 16px;\n          }\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-voice-command-dialog\": HaVoiceCommandDialog;\n  }\n}\n"],"names":[],"sourceRoot":""}