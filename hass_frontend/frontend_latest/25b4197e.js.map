{"version":3,"file":"25b4197e.js","mappings":";;AA8FA;;AAEA;;;AAGA;;AAIA;AACA;;AAIA;AAxBA;;AA2BA;AACA;AACA;AACA;;AAEA;AAEA;;AAGA;AAEA;;;AAGA;;;AAGA;;;;;;AASA;;;AAIA;;AAIA;AAEA;;AAEA;AACA;AAKA;;;;AAQA;;AAIA;AACA;;;AAGA;AAEA;;;AAGA;;;;AAUA;AACA;AACA;;;;;;AAMA;;;AASA;AACA;AACA;;AAEA;;;AAIA;;;AAIA;AACA;AAGA;;;;AAIA;;AAGA;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAIA;AACA;;AAEA;;AAIA;AACA;AACA;AACA;;AAEA;;AAIA;AACA;;AAEA;;AAGA;AACA;AACA;AACA;AACA;;;;;;;AAzOA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA","sources":["webpack://home-assistant-frontend/./src/panels/config/automation/ha-automation-trace.ts"],"sourcesContent":["import {\n  mdiDownload,\n  mdiPencil,\n  mdiRayEndArrow,\n  mdiRayStartArrow,\n  mdiRefresh,\n} from \"@mdi/js\";\nimport { css, CSSResultGroup, html, LitElement, TemplateResult } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport { repeat } from \"lit/directives/repeat\";\nimport { isComponentLoaded } from \"../../../common/config/is_component_loaded\";\nimport { formatDateTimeWithSeconds } from \"../../../common/datetime/format_date_time\";\nimport \"../../../components/ha-icon-button\";\nimport \"../../../components/trace/ha-trace-blueprint-config\";\nimport \"../../../components/trace/ha-trace-config\";\nimport \"../../../components/trace/ha-trace-logbook\";\nimport \"../../../components/trace/ha-trace-path-details\";\nimport \"../../../components/trace/ha-trace-timeline\";\nimport \"../../../components/trace/hat-script-graph\";\nimport type {\n  HatScriptGraph,\n  NodeInfo,\n} from \"../../../components/trace/hat-script-graph\";\nimport { traceTabStyles } from \"../../../components/trace/trace-tab-styles\";\nimport { AutomationEntity } from \"../../../data/automation\";\nimport { getLogbookDataForContext, LogbookEntry } from \"../../../data/logbook\";\nimport {\n  AutomationTrace,\n  AutomationTraceExtended,\n  loadTrace,\n  loadTraces,\n} from \"../../../data/trace\";\nimport { showAlertDialog } from \"../../../dialogs/generic/show-dialog-box\";\nimport { haStyle } from \"../../../resources/styles\";\nimport { HomeAssistant, Route } from \"../../../types\";\nimport { configSections } from \"../ha-panel-config\";\n\n@customElement(\"ha-automation-trace\")\nexport class HaAutomationTrace extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property() public automationId!: string;\n\n  @property({ attribute: false }) public automations!: AutomationEntity[];\n\n  @property({ type: Boolean }) public isWide?: boolean;\n\n  @property({ type: Boolean, reflect: true }) public narrow!: boolean;\n\n  @property({ attribute: false }) public route!: Route;\n\n  @state() private _entityId?: string;\n\n  @state() private _traces?: AutomationTrace[];\n\n  @state() private _runId?: string;\n\n  @state() private _selected?: NodeInfo;\n\n  @state() private _trace?: AutomationTraceExtended;\n\n  @state() private _logbookEntries?: LogbookEntry[];\n\n  @state() private _view:\n    | \"details\"\n    | \"config\"\n    | \"timeline\"\n    | \"logbook\"\n    | \"blueprint\" = \"details\";\n\n  @query(\"hat-script-graph\") private _graph?: HatScriptGraph;\n\n  protected render(): TemplateResult {\n    const stateObj = this._entityId\n      ? this.hass.states[this._entityId]\n      : undefined;\n\n    const graph = this._graph;\n    const trackedNodes = graph?.trackedNodes;\n    const renderedNodes = graph?.renderedNodes;\n\n    const title = stateObj?.attributes.friendly_name || this._entityId;\n\n    let devButtons: TemplateResult | string = \"\";\n    if (__DEV__) {\n      devButtons = html`<div style=\"position: absolute; right: 0;\">\n        <button @click=${this._importTrace}>Import trace</button>\n        <button @click=${this._loadLocalStorageTrace}>Load stored trace</button>\n      </div>`;\n    }\n\n    const actionButtons = html`\n      <ha-icon-button\n        .label=${this.hass.localize(\"ui.panel.config.automation.trace.refresh\")}\n        .path=${mdiRefresh}\n        @click=${this._refreshTraces}\n      ></ha-icon-button>\n      <ha-icon-button\n        .label=${this.hass.localize(\n          \"ui.panel.config.automation.trace.download_trace\"\n        )}\n        .path=${mdiDownload}\n        .disabled=${!this._trace}\n        @click=${this._downloadTrace}\n      ></ha-icon-button>\n    `;\n\n    return html`\n      ${devButtons}\n      <hass-tabs-subpage\n        .hass=${this.hass}\n        .narrow=${this.narrow}\n        .route=${this.route}\n        .tabs=${configSections.automations}\n      >\n        ${this.narrow\n          ? html`<span slot=\"header\">${title}</span>\n              <div slot=\"toolbar-icon\">${actionButtons}</div>`\n          : \"\"}\n        <div class=\"toolbar\">\n          ${!this.narrow\n            ? html`<div>\n                ${title}\n                <a\n                  class=\"linkButton\"\n                  href=\"/config/automation/edit/${this.automationId}\"\n                >\n                  <ha-icon-button\n                    .label=${this.hass!.localize(\n                      \"ui.panel.config.automation.trace.edit_automation\"\n                    )}\n                    .path=${mdiPencil}\n                    tabindex=\"-1\"\n                  ></ha-icon-button>\n                </a>\n              </div>`\n            : \"\"}\n          ${this._traces && this._traces.length > 0\n            ? html`\n                <div>\n                  <ha-icon-button\n                    .label=${this.hass!.localize(\n                      \"ui.panel.config.automation.trace.older_trace\"\n                    )}\n                    .path=${mdiRayEndArrow}\n                    .disabled=${this._traces[this._traces.length - 1].run_id ===\n                    this._runId}\n                    @click=${this._pickOlderTrace}\n                  ></ha-icon-button>\n                  <select .value=${this._runId} @change=${this._pickTrace}>\n                    ${repeat(\n                      this._traces,\n                      (trace) => trace.run_id,\n                      (trace) =>\n                        html`<option value=${trace.run_id}>\n                          ${formatDateTimeWithSeconds(\n                            new Date(trace.timestamp.start),\n                            this.hass.locale\n                          )}\n                        </option>`\n                    )}\n                  </select>\n                  <ha-icon-button\n                    .label=${this.hass!.localize(\n                      \"ui.panel.config.automation.trace.newer_trace\"\n                    )}\n                    .path=${mdiRayStartArrow}\n                    .disabled=${this._traces[0].run_id === this._runId}\n                    @click=${this._pickNewerTrace}\n                  ></ha-icon-button>\n                </div>\n              `\n            : \"\"}\n          ${!this.narrow ? html`<div>${actionButtons}</div>` : \"\"}\n        </div>\n\n        ${this._traces === undefined\n          ? html`<div class=\"container\">Loadingâ€¦</div>`\n          : this._traces.length === 0\n          ? html`<div class=\"container\">No traces found</div>`\n          : this._trace === undefined\n          ? \"\"\n          : html`\n              <div class=\"main\">\n                <div class=\"graph\">\n                  <hat-script-graph\n                    .trace=${this._trace}\n                    .selected=${this._selected?.path}\n                    @graph-node-selected=${this._pickNode}\n                  ></hat-script-graph>\n                </div>\n\n                <div class=\"info\">\n                  <div class=\"tabs top\">\n                    ${[\n                      [\"details\", \"Step Details\"],\n                      [\"timeline\", \"Trace Timeline\"],\n                      [\"logbook\", \"Related logbook entries\"],\n                      [\"config\", \"Automation Config\"],\n                    ].map(\n                      ([view, label]) => html`\n                        <button\n                          tabindex=\"0\"\n                          .view=${view}\n                          class=${classMap({ active: this._view === view })}\n                          @click=${this._showTab}\n                        >\n                          ${label}\n                        </button>\n                      `\n                    )}\n                    ${this._trace.blueprint_inputs\n                      ? html`\n                          <button\n                            tabindex=\"0\"\n                            .view=${\"blueprint\"}\n                            class=${classMap({\n                              active: this._view === \"blueprint\",\n                            })}\n                            @click=${this._showTab}\n                          >\n                            Blueprint Config\n                          </button>\n                        `\n                      : \"\"}\n                  </div>\n                  ${this._selected === undefined ||\n                  this._logbookEntries === undefined ||\n                  trackedNodes === undefined\n                    ? \"\"\n                    : this._view === \"details\"\n                    ? html`\n                        <ha-trace-path-details\n                          .hass=${this.hass}\n                          .narrow=${this.narrow}\n                          .trace=${this._trace}\n                          .selected=${this._selected}\n                          .logbookEntries=${this._logbookEntries}\n                          .trackedNodes=${trackedNodes}\n                          .renderedNodes=${renderedNodes!}\n                        ></ha-trace-path-details>\n                      `\n                    : this._view === \"config\"\n                    ? html`\n                        <ha-trace-config\n                          .hass=${this.hass}\n                          .trace=${this._trace}\n                        ></ha-trace-config>\n                      `\n                    : this._view === \"logbook\"\n                    ? html`\n                        <ha-trace-logbook\n                          .hass=${this.hass}\n                          .narrow=${this.narrow}\n                          .trace=${this._trace}\n                          .logbookEntries=${this._logbookEntries}\n                        ></ha-trace-logbook>\n                      `\n                    : this._view === \"blueprint\"\n                    ? html`\n                        <ha-trace-blueprint-config\n                          .hass=${this.hass}\n                          .trace=${this._trace}\n                        ></ha-trace-blueprint-config>\n                      `\n                    : html`\n                        <ha-trace-timeline\n                          .hass=${this.hass}\n                          .trace=${this._trace}\n                          .logbookEntries=${this._logbookEntries}\n                          .selected=${this._selected}\n                          @value-changed=${this._timelinePathPicked}\n                        ></ha-trace-timeline>\n                      `}\n                </div>\n              </div>\n            `}\n      </hass-tabs-subpage>\n    `;\n  }\n\n  protected firstUpdated(changedProps) {\n    super.firstUpdated(changedProps);\n\n    if (!this.automationId) {\n      return;\n    }\n\n    const params = new URLSearchParams(location.search);\n    this._loadTraces(params.get(\"run_id\") || undefined);\n  }\n\n  protected updated(changedProps) {\n    super.updated(changedProps);\n\n    // Only reset if automationId has changed and we had one before.\n    if (changedProps.get(\"automationId\")) {\n      this._traces = undefined;\n      this._entityId = undefined;\n      this._runId = undefined;\n      this._trace = undefined;\n      this._logbookEntries = undefined;\n      if (this.automationId) {\n        this._loadTraces();\n      }\n    }\n\n    if (changedProps.has(\"_runId\") && this._runId) {\n      this._trace = undefined;\n      this._logbookEntries = undefined;\n      this._loadTrace();\n    }\n\n    if (\n      changedProps.has(\"automations\") &&\n      this.automationId &&\n      !this._entityId\n    ) {\n      const automation = this.automations.find(\n        (entity: AutomationEntity) => entity.attributes.id === this.automationId\n      );\n      this._entityId = automation?.entity_id;\n    }\n  }\n\n  private _pickOlderTrace() {\n    const curIndex = this._traces!.findIndex((tr) => tr.run_id === this._runId);\n    this._runId = this._traces![curIndex + 1].run_id;\n    this._selected = undefined;\n  }\n\n  private _pickNewerTrace() {\n    const curIndex = this._traces!.findIndex((tr) => tr.run_id === this._runId);\n    this._runId = this._traces![curIndex - 1].run_id;\n    this._selected = undefined;\n  }\n\n  private _pickTrace(ev) {\n    this._runId = ev.target.value;\n    this._selected = undefined;\n  }\n\n  private _pickNode(ev) {\n    this._selected = ev.detail;\n  }\n\n  private _refreshTraces() {\n    this._loadTraces();\n  }\n\n  private async _loadTraces(runId?: string) {\n    this._traces = await loadTraces(this.hass, \"automation\", this.automationId);\n    // Newest will be on top.\n    this._traces.reverse();\n\n    if (runId) {\n      this._runId = runId;\n    }\n\n    // Check if current run ID still exists\n    if (\n      this._runId &&\n      !this._traces.some((trace) => trace.run_id === this._runId)\n    ) {\n      this._runId = undefined;\n      this._selected = undefined;\n\n      // If we came here from a trace passed into the url, clear it.\n      if (runId) {\n        const params = new URLSearchParams(location.search);\n        params.delete(\"run_id\");\n        history.replaceState(\n          null,\n          \"\",\n          `${location.pathname}?${params.toString()}`\n        );\n      }\n\n      await showAlertDialog(this, {\n        text: \"Chosen trace is no longer available\",\n      });\n    }\n\n    // See if we can set a default runID\n    if (!this._runId && this._traces.length > 0) {\n      this._runId = this._traces[0].run_id;\n    }\n  }\n\n  private async _loadTrace() {\n    const trace = await loadTrace(\n      this.hass,\n      \"automation\",\n      this.automationId,\n      this._runId!\n    );\n    this._logbookEntries = isComponentLoaded(this.hass, \"logbook\")\n      ? await getLogbookDataForContext(\n          this.hass,\n          trace.timestamp.start,\n          trace.context.id\n        )\n      : [];\n\n    this._trace = trace;\n  }\n\n  private _downloadTrace() {\n    const aEl = document.createElement(\"a\");\n    aEl.download = `trace ${this._entityId} ${\n      this._trace!.timestamp.start\n    }.json`;\n    aEl.href = `data:application/json;charset=utf-8,${encodeURI(\n      JSON.stringify(\n        {\n          trace: this._trace,\n          logbookEntries: this._logbookEntries,\n        },\n        undefined,\n        2\n      )\n    )}`;\n    aEl.click();\n  }\n\n  private _importTrace() {\n    const traceText = prompt(\"Enter downloaded trace\");\n    if (!traceText) {\n      return;\n    }\n    localStorage.devTrace = traceText;\n    this._loadLocalTrace(traceText);\n  }\n\n  private _loadLocalStorageTrace() {\n    if (localStorage.devTrace) {\n      this._loadLocalTrace(localStorage.devTrace);\n    }\n  }\n\n  private _loadLocalTrace(traceText: string) {\n    const traceInfo = JSON.parse(traceText);\n    this._trace = traceInfo.trace;\n    this._logbookEntries = traceInfo.logbookEntries;\n  }\n\n  private _showTab(ev: Event) {\n    this._view = (ev.target as any).view;\n  }\n\n  private _timelinePathPicked(ev: CustomEvent) {\n    const path = ev.detail.value;\n    const nodes = this._graph!.trackedNodes;\n    if (nodes[path]) {\n      this._selected = nodes[path];\n    }\n  }\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyle,\n      traceTabStyles,\n      css`\n        .toolbar {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          font-size: 20px;\n          height: var(--header-height);\n          padding: 0 16px;\n          background-color: var(--primary-background-color);\n          font-weight: 400;\n          color: var(--app-header-text-color, white);\n          border-bottom: var(--app-header-border-bottom, none);\n          box-sizing: border-box;\n        }\n\n        .toolbar > * {\n          display: flex;\n          align-items: center;\n        }\n\n        :host([narrow]) .toolbar > * {\n          display: contents;\n        }\n\n        .main {\n          height: calc(100% - 56px);\n          display: flex;\n          background-color: var(--card-background-color);\n        }\n\n        :host([narrow]) .main {\n          height: auto;\n          flex-direction: column;\n        }\n\n        .container {\n          padding: 16px;\n        }\n\n        .graph {\n          border-right: 1px solid var(--divider-color);\n          overflow-x: auto;\n          max-width: 50%;\n          padding-bottom: 16px;\n        }\n        :host([narrow]) .graph {\n          max-width: 100%;\n          justify-content: center;\n          display: flex;\n        }\n\n        .info {\n          flex: 1;\n          background-color: var(--card-background-color);\n        }\n\n        .linkButton {\n          color: var(--primary-text-color);\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-automation-trace\": HaAutomationTrace;\n  }\n}\n"],"names":[],"sourceRoot":""}